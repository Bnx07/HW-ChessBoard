<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess Board</title>
  <style>
    table {
      border: 1px solid black;
    }

    td {
      border: 1px solid black;
      height: 100px;
      width: 100px;
      position: relative;
    }

    .fa-regular,
    .fa-solid {
      font-size: 50px;
    }

    .dark {
      background-color: grey;
    }

    .possible {
      background-color: rgb(40, 122, 40) !important;
    }

    .attack {
      background-color: rgb(202, 69, 69) !important;
    }

    .self {
      background-color: rgb(40, 48, 122) !important;
    }

    .piece {
      cursor: pointer;
      position: absolute;
    }
  </style>
</head>

<body>
  <h1>Añadir color verde a casillas vacias en posible movimiento</h1>
  <h1>Añadir color rojo a casillas ocupadas en posible movimiento</h1>
  <h1>Añadir que cuando elegis una pieza, el selected te muestre los posibles movimientos</h1>
  <h1>Hacer que se puedan comer piezas</h1>
  <h1>Hacer que cuando un peon llegue al final, puedas elegir a qué corona</h1>
  <h1>Hacer que no haya logica de detectar qué pieza se movió, si no que se detecte por qué valor tenia cuando se movio,
    no detectando la pieza en si</h1>
  <h1>GUARDA MAL EL TABLERO POR ESO NO ANDA, CREAR VARIABLE EN HTML</h1>
  <table id="chessboard">
    <!-- Primera fila -->
    <tr>
      <td id="square_0_0" class="dark"><i class="fa-solid fa-chess-rook piece"></i></td>
      <td id="square_0_1"><i class="fa-solid fa-chess-knight piece"></i></td>
      <td id="square_0_2" class="dark"><i class="fa-solid fa-chess-bishop piece"></i></td>
      <td id="square_0_3"><i class="fa-solid fa-chess-queen piece"></i></td>
      <td id="square_0_4" class="dark"><i class="fa-solid fa-chess-king piece"></i></td>
      <td id="square_0_5"><i class="fa-solid fa-chess-bishop piece"></i></td>
      <td id="square_0_6" class="dark"><i class="fa-solid fa-chess-knight piece"></i></td>
      <td id="square_0_7"><i class="fa-solid fa-chess-rook piece"></i></td>
    </tr>
    <!-- Segunda fila -->
    <tr>
      <td id="square_1_0"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_1" class="dark"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_2"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_3" class="dark"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_4"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_5" class="dark"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_6"><i class="fa-solid fa-chess-pawn piece"></i></td>
      <td id="square_1_7" class="dark"><i class="fa-solid fa-chess-pawn piece"></i></td>
    </tr>
    <!-- Filas vacías -->
    <tr>
      <td id="square_2_0" class="dark"></td>
      <td id="square_2_1"></td>
      <td id="square_2_2" class="dark"></td>
      <td id="square_2_3"></td>
      <td id="square_2_4" class="dark"></td>
      <td id="square_2_5"></td>
      <td id="square_2_6" class="dark"></td>
      <td id="square_2_7"></td>
    </tr>
    <tr>
      <td id="square_3_0"></td>
      <td id="square_3_1" class="dark"></td>
      <td id="square_3_2"></td>
      <td id="square_3_3" class="dark"></td>
      <td id="square_3_4"></td>
      <td id="square_3_5" class="dark"></td>
      <td id="square_3_6"></td>
      <td id="square_3_7" class="dark"></td>
    </tr>
    <tr>
      <td id="square_4_0" class="dark"></td>
      <td id="square_4_1"></td>
      <td id="square_4_2" class="dark"></td>
      <td id="square_4_3"></td>
      <td id="square_4_4" class="dark"></td>
      <td id="square_4_5"></td>
      <td id="square_4_6" class="dark"></td>
      <td id="square_4_7"></td>
    </tr>
    <tr>
      <td id="square_5_0"></td>
      <td id="square_5_1" class="dark"></td>
      <td id="square_5_2"></td>
      <td id="square_5_3" class="dark"></td>
      <td id="square_5_4"></td>
      <td id="square_5_5" class="dark"></td>
      <td id="square_5_6"></td>
      <td id="square_5_7" class="dark"></td>
    </tr>
    <!-- Últimas dos filas -->
    <tr>
      <td id="square_6_0" class="dark"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_1"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_2" class="dark"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_3"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_4" class="dark"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_5"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_6" class="dark"><i class="fa-regular fa-chess-pawn piece"></i></td>
      <td id="square_6_7"><i class="fa-regular fa-chess-pawn piece"></i></td>
    </tr>
    <tr>
      <td id="square_7_0"><i class="fa-regular fa-chess-rook piece"></i></td>
      <td id="square_7_1" class="dark"><i class="fa-regular fa-chess-knight piece"></i></td>
      <td id="square_7_2"><i class="fa-regular fa-chess-bishop piece"></i></td>
      <td id="square_7_3" class="dark"><i class="fa-regular fa-chess-queen piece"></i></td>
      <td id="square_7_4"><i class="fa-regular fa-chess-king piece"></i></td>
      <td id="square_7_5" class="dark"><i class="fa-regular fa-chess-bishop piece"></i></td>
      <td id="square_7_6"><i class="fa-regular fa-chess-knight piece"></i></td>
      <td id="square_7_7" class="dark"><i class="fa-regular fa-chess-rook piece"></i></td>
    </tr>
  </table>

  <script>
    // Función para mover una pieza de un div a otro

    let newBoardOld = [
      [4, 6, 8, 10, 12, 8, 6, 4],
      [2, 2, 2, 2, 2, 2, 2, 2],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 1, 1, 1, 1, 1],
      [3, 5, 7, 9, 11, 7, 5, 3]
    ]

    let newBoard = [
      [4, 6, 8, 10, 12, 8, 6, 4],
      [2, 2, 2, 2, 2, 2, 2, 2],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [0, 0, 0, 0, 0, 0, 0, 0],
      [1, 1, 1, 1, 1, 1, 1, 1],
      [3, 5, 7, 9, 11, 7, 5, 3]
    ]

    function movePiece(sourceId, targetId) {
      const sourceSquare = document.getElementById(sourceId);
      const targetSquare = document.getElementById(targetId);

      if (sourceSquare && targetSquare) {
        const piece = sourceSquare.querySelector('.piece');

        if (piece) {
          targetSquare.appendChild(piece);
        }
      }
    }

    // Manejador de clic para las celdas
    function cellClickHandler(event) {
      const clickedCell = event.target;

      if (clickedCell.classList.contains('piece')) {
        // Si se hizo clic en una pieza, guarda su posición actual
        clickedCell.classList.add('selected');

        const sourceId = clickedCell.parentNode.id; // square_1_4

        const parts = sourceId.split('_');
        const row = parseInt(parts[2], 10);
        const col = parseInt(parts[1], 10);

        excecutePiece(col, row);

        // Adjunta un manejador de clic al tablero para seleccionar el destino
        document.getElementById('chessboard').addEventListener('click', function targetClickHandler(event) {
          const targetCell = event.target;

          if (targetCell.tagName === 'TD' && !targetCell.contains(clickedCell)) {
            
            // Mueve la pieza y elimina la selección
            const targetId = targetCell.id;
            movePiece(sourceId, targetId);
            clickedCell.classList.remove('selected');

            removePaint();

            newBoard = saveBoardState(newBoard, newBoardOld);

            // Elimina el manejador de clic del tablero después de realizar el movimiento
            document.getElementById('chessboard').removeEventListener('click', targetClickHandler);
          }
        });
      }
    }

    // Adjunta el manejador de clic a todas las celdas del tablero
    const cells = document.querySelectorAll('td');
    cells.forEach(cell => {
      cell.addEventListener('click', cellClickHandler);
    });

    // Función para guardar el estado del tablero en una variable
    function saveBoardState(boardState, prevBoard) {
      prevBoard = boardState;
      boardState = [];
      const chessboard = document.getElementById('chessboard');
      const rows = chessboard.querySelectorAll('tr');

      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td');
        const rowData = [];

        cells.forEach(cell => {
          const piece = cell.querySelector('.piece');
          let pieceValue;

          if (piece) {
            const pieceClass = piece.classList.item(1);

            switch (pieceClass) {
              case 'fa-chess-pawn':
                pieceValue = piece.classList.contains('fa-regular') ? 1 : 2;
                break;
              case 'fa-chess-rook':
                pieceValue = piece.classList.contains('fa-regular') ? 3 : 4;
                break;
              case 'fa-chess-knight':
                pieceValue = piece.classList.contains('fa-regular') ? 5 : 6;
                break;
              case 'fa-chess-bishop':
                pieceValue = piece.classList.contains('fa-regular') ? 7 : 8;
                break;
              case 'fa-chess-queen':
                pieceValue = piece.classList.contains('fa-regular') ? 11 : 12;
                break;
              case 'fa-chess-king':
                pieceValue = piece.classList.contains('fa-regular') ? 9 : 10;
                break;
              default:
                pieceValue = 0;
            }
          } else {
            pieceValue = 0;
          }

          rowData.push(pieceValue);
        });

        boardState.push(rowData);
      });

      // Ahora, boardState contiene la matriz 8x8 con los valores numéricos de las piezas en cada celda

      return boardState;
    }

    const paint = (positions, allCells, self) => {
      let newPositions = []
      let newRedPositions = [];

      positions.forEach(element => {
        console.log(element)
        let square = element[0] * 8 + element[1];
        if (newBoard[element[0]][element[1]] != 0) {
          newRedPositions.push(square)
        } else {
          newPositions.push(square);
        }
      })

      console.log(newPositions)

      newPositions.forEach(element => {
        allCells[element].classList.add("possible");
      })

      newRedPositions.forEach(element => {
        allCells[element].classList.add("attack");
      })

      allCells[self[0] * 8 + self[1]].classList.add("self");
    }

    const removePaint = () => {
      let green = document.getElementsByClassName('possible');

      green = green[0];

      while (green != null) {
        green.classList.remove('possible');

        green = document.getElementsByClassName('possible');

        green = green[0];
      }

      let blue = document.getElementsByClassName('self');

      blue = blue[0];

      while (blue != null) {
        blue.classList.remove('self');

        blue = document.getElementsByClassName('self');

        blue = blue[0];
      }

      let red = document.getElementsByClassName('attack');

      red = red[0];

      while (red != null) {
        red.classList.remove('attack');

        red = document.getElementsByClassName('attack');

        red = red[0];
      }
    }

    const movePawn = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = pawnMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const moveRook = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = rookMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const moveHorse = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = horseMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const moveBishop = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = bishopMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const moveKing = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = kingMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const moveQueen = (col, row, whitePiece) => {
      const allCells = document.querySelectorAll('td')
      let positions = queenMovement(newBoard, [col, row], whitePiece);
      paint(positions, allCells, [col, row]);
    }

    const excecutePiece = (col, row) => {
      let square = col * 8 + row;
      console.log(square);
      let isWhite = true;
      
      console.log("PIEZA: ", newBoard[col][row])
      
      let type = detectPiece([col, row], newBoard);
      
      console.log("TYPE: ", type)

      if (newBoard[col][row] % 2 == 0) {
        console.log("ES IMPAR")
        isWhite = false
      }

      console.log("ES BLANCA: ", isWhite);

      switch (type) {
        case "pawn":
          movePawn(col, row, isWhite)
          break;
        case "rook":
          moveRook(col, row, isWhite)
          break;
        case "knight":
          moveHorse(col, row, isWhite)
          break;
        case "bishop":
          moveBishop(col, row, isWhite)
          break;
        case "king":
          moveKing(col, row, isWhite)
          break;
        case "queen":
          moveQueen(col, row, isWhite)
          break;
      }

    }

  </script>
  <script src="all.js"></script>
  <script src="https://kit.fontawesome.com/490d09fdd3.js" crossorigin="anonymous"></script>
</body>

</html>